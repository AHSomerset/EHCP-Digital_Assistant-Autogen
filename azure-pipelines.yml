# azure-pipelines.yml
# This single pipeline handles both Development and Production deployments
# based on the Git branch that triggers it.

trigger:
  branches:
    include:
      - main
      - develop

# Global variables available to all stages
variables:
  imageName: 'my-autogen-app'
  # The Resource Group is the same for both Dev and Prod based on your constraint.
  # This is pulled from a variable group for security.
  resourceGroup: $(RESOURCE_GROUP) 

stages:
# ==============================================================================
# STAGE 1: Build the Docker image and push it to the correct ACR.
# This stage is the same for both Dev and Prod, but it uses conditional
# logic to choose the right registry and image tag.
# ==============================================================================
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildJob
    displayName: 'Build'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      name: 'BuildAndPush' # A name for this step to reference its outputs later
      displayName: 'Build and Push to Container Registry'
      inputs:
        # This uses your PROD connection by default. It only needs AcrPush,
        # which should be safe. If you have a separate Dev connection, you can
        # add logic here to switch connections.
        azureSubscription: 'AzureProdConnection' 
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # 1. Set environment-specific variables based on the branch
          if [[ "$(Build.SourceBranchName)" == "main" ]]; then
            echo "BUILD: Building for PRODUCTION from 'main' branch."
            ACR_NAME="$(ACR_NAME_PROD)"
            IMAGE_TAG="v$(Build.BuildId)" # e.g., v20250815.1 (Immutable)
          else
            echo "BUILD: Building for DEVELOPMENT from '$(Build.SourceBranchName)' branch."
            ACR_NAME="$(ACR_NAME_DEV)"
            IMAGE_TAG="dev-latest" # Floating tag for Dev
          fi
          
          echo "ACR Name: $ACR_NAME"
          echo "Image Tag: $IMAGE_TAG"

          
          echo "== CONTEXT =="
          az account show --query "{name:name,id:id,tenantId:tenantId}" -o tsv
          
          echo "== RAW VARS =="
          echo "ACR_NAME_PROD='$(ACR_NAME_PROD)'"
          echo "RESOURCE_GROUP='$(RESOURCE_GROUP)'"
          echo "PROD_SUBSCRIPTION_ID='$(PROD_SUBSCRIPTION_ID)'"
          
          # Sanitize to bare name (no FQDN)
          ACR_PROD_CLEAN="$(echo "$(ACR_NAME_PROD)" | sed -E 's~^https?://~~; s~\.azurecr\.io/?$~~; s/[[:space:]]+$//')"
          echo "ACR_PROD_CLEAN='${ACR_PROD_CLEAN}'"
          
          echo "== TRY SHOW by name (may fail on RBAC) =="
          az acr show -n "${ACR_PROD_CLEAN}" -o table || true
          
          echo "== TRY SHOW by RG (if RG is correct) =="
          az acr show -n "${ACR_PROD_CLEAN}" -g "$(RESOURCE_GROUP)" -o table || true
          
          echo "== LIST registries (may RBAC-fail) =="
          az acr list -o table || true

          
          # 2. Build and Push the image using the Azure CLI
          az acr build \
            --registry $ACR_NAME \
            --image $(imageName):$IMAGE_TAG \
            .
            
          # 3. Share these variables with the next stage (Deploy)
          echo "##vso[task.setvariable variable=ACR_NAME;isOutput=true]$ACR_NAME"
          echo "##vso[task.setvariable variable=IMAGE_TAG;isOutput=true]$IMAGE_TAG"

# ==============================================================================
# STAGE 2: Deploy the new image to the correct Container App Job.
# This stage contains two separate jobs with conditions. Only one will run.
# ==============================================================================
- stage: Deploy
  displayName: 'Deploy to Environment'
  dependsOn: Build
  jobs:
  # --- JOB A: Deploy to Development ---
  - job: Deploy_Dev
    displayName: 'Deploy to Development'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'develop')) # Only runs for the 'develop' branch
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      # Ingest the variables from the previous Build stage
      ACR_NAME: $[ stageDependencies.Build.BuildJob.outputs['BuildAndPush.ACR_NAME'] ]
      IMAGE_TAG: $[ stageDependencies.Build.BuildJob.outputs['BuildAndPush.IMAGE_TAG'] ]
    steps:
    - task: AzureCLI@2
      displayName: 'Update DEV Container App Job'
      inputs:
        azureSubscription: 'AzureDevConnection' # <-- USES THE DEV-ONLY CONNECTION
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "DEPLOY: Deploying image $(imageName):$(IMAGE_TAG) to DEV job."
          az containerapp job update \
            --name "$(JOB_NAME_DEV)" \
            --resource-group $(resourceGroup) \
            --image "$(ACR_NAME).azurecr.io/$(imageName):$(IMAGE_TAG)"

  # --- JOB B: Deploy to Production ---
  - job: Deploy_Prod
    displayName: 'Deploy to Production'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main')) # Only runs for the 'main' branch
    pool:
      vmImage: 'ubuntu-latest'
    variables:
      ACR_NAME: $[ stageDependencies.Build.BuildJob.outputs['BuildAndPush.ACR_NAME'] ]
      IMAGE_TAG: $[ stageDependencies.Build.BuildJob.outputs['BuildAndPush.IMAGE_TAG'] ]
    steps:
    - task: AzureCLI@2
      displayName: 'Update PROD Container App Job'
      inputs:
        azureSubscription: 'AzureProdConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail

          # Ensure this is the bare registry resource name
          ACR_PROD_CLEAN="$(echo "$(ACR_NAME_PROD)" | sed -E 's~^https?://~~; s~\.azurecr\.io/?$~~; s/[[:space:]]+$//')"

          # Ask Azure for the real login server (respects DNL/hashes)
          ACR_LOGIN_SERVER="$(az acr show -n "${ACR_PROD_CLEAN}" --query loginServer -o tsv)"

          echo "Using ACR login server: ${ACR_LOGIN_SERVER}"
          echo "Deploying image: ${ACR_LOGIN_SERVER}/$(imageName):$(IMAGE_TAG)"

          az containerapp job update \
            --name "$(JOB_NAME_PROD)" \
            --resource-group "$(RESOURCE_GROUP)" \
            --image "${ACR_LOGIN_SERVER}/$(imageName):$(IMAGE_TAG)"

 
