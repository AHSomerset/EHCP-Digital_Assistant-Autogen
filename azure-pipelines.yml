trigger:
  branches:
    include:
      - main
      - develop

variables:
  imageName: 'my-ehcp-app'
  
stages:
# ==============================================================================
# STAGE 1: Build the Docker image
# Contains two separate, conditional jobs. Only one will run per pipeline.
# ==============================================================================
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  # --- JOB A: Build for Development ---
  - job: Build_Dev
    displayName: 'Build DEV Image'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'develop'))
    pool: { vmImage: 'ubuntu-latest' }
    steps:
    - task: AzureCLI@2
      name: 'BuildAndPushDev'
      displayName: 'Build and Push to DEV ACR'
      inputs:
        azureSubscription: 'AzureDevConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az acr build --registry $(ACR_NAME_DEV) --image $(imageName):dev-latest .
          echo "##vso[task.setvariable variable=IMAGE_TAG;isOutput=true]dev-latest"

  # --- JOB B: Build for Production ---
  - job: Build_Prod
    displayName: 'Build PROD Image'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
    pool: { vmImage: 'ubuntu-latest' }
    steps:
    - task: AzureCLI@2
      name: 'BuildAndPushProd'
      displayName: 'Build and Push to PROD ACR'
      inputs:
        azureSubscription: 'AzureProdConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          IMAGE_TAG="v$(Build.BuildId)"
          az acr build --registry $(ACR_NAME_PROD) --image $(imageName):$IMAGE_TAG .
          echo "##vso[task.setvariable variable=IMAGE_TAG;isOutput=true]$IMAGE_TAG"

# ==============================================================================
# STAGE 2: Deploy the new image
# Also contains two separate, conditional jobs.
# ==============================================================================
- stage: Deploy
  displayName: 'Deploy to Environment'
  dependsOn: Build
  jobs:
  # --- JOB A: Deploy to Development ---
  - job: Deploy_Dev
    displayName: 'Deploy to Development'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'develop'))
    pool: { vmImage: 'ubuntu-latest' }
    variables:
      IMAGE_TAG: $[ stageDependencies.Build.Build_Dev.outputs['BuildAndPushDev.IMAGE_TAG'] ]
    steps:
    - task: AzureCLI@2
      displayName: 'Update DEV Container App Job'
      inputs:
        azureSubscription: 'AzureDevConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az containerapp job update --name "$(JOB_NAME_DEV)" --resource-group "$(RESOURCE_GROUP)" --image "$(ACR_NAME_DEV).azurecr.io/$(imageName):$(IMAGE_TAG)"

  # --- JOB B: Deploy to Production ---
  - job: Deploy_Prod
    displayName: 'Deploy to Production'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'main'))
    pool: { vmImage: 'ubuntu-latest' }
    variables:
      IMAGE_TAG: $[ stageDependencies.Build.Build_Prod.outputs['BuildAndPushProd.IMAGE_TAG'] ]
    steps:
    - task: AzureCLI@2
      displayName: 'Update PROD Container App Job'
      inputs:
        azureSubscription: 'AzureProdConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az containerapp job update --name "$(JOB_NAME_PROD)" --resource-group "$(RESOURCE_GROUP)" --image "$(ACR_NAME_PROD).azurecr.io/$(imageName):$(IMAGE_TAG)"
